# 01.08 FE 스터디 주제

- 자바스크립트 이벤트 루프 및 비동기 처리 (스레드와 프로세스, 실행 컨텍스트 포함)
- V8 엔진 작동 원리 (컴파일러와 인터프리터)
- 추가로 생각해보기
  - 왜 자바스크립트는 싱글 스레드로 만들었을까?
  - 스레드는? 프로세스는? 싱글 스레드와 멀티 스레드의 차이는? 멀티 스레드의 동작 방식에서 발생하는 문제는 무엇이 있을까?
  - 그러면 왜 싱글 스레드로 만들었을까? 어떤 이점이 있을까?
  - 단점은 어떤 것이 있을까? 보완하기 위해서 브라우저는 어떤 식으로 동작하고 있을까?
  - 이벤트 루프

---

### 🍔 자바스크립트가 싱글 스레드로 설계된 이유

자바스크립트가 싱글 스레드로 설계된 주요 이유는 웹 브라우저 환경에서의 안전성과 간결함에 있습니다.

- 싱글 스레드로 작동하는 언어는 동시성을 다루기가 더 쉽다고 합니다. 이는 **개발자들이 코드를 작성하고 유지보수하는 데 도움이 됩니다.** 멀티 스레드 환경에서의 동시성 문제는 복잡하고 어렵게 다루어지기 때문에, **싱글 스레드로 구현함으로써 언어의 간결성과 단순성을 유지할 수 있었습니다.**

- 브라우저는 여러 웹 페이지가 동시에 열릴 수 있고, 각 페이지는 자바스크립트를 실행할 수 있습니다. 만약 자바스크립트가 멀티 스레드로 동작한다면, 여러 페이지 간에 상호작용하거나 데이터를 공유하는 것이 더 복잡해지고 보안 문제가 발생할 수 있다고 합니다. **싱글 스레드로 작동함으로써 각 페이지의 자바스크립트 코드가 서로 간섭하지 않도록 보장됩니다.**

- 자바스크립트는 이벤트 기반 비동기 모델을 사용해 비동기 작업을 처리합니다. 이 모델은 싱글 스레드에서도 효과적으로 동작할 수 있도록 설계되었습니다. **이벤트 루프**를 통해 이벤트 및 콜백 함수들이 순차적으로 실행되면서 비동기적인 작업을 처리할 수 있습니다.

- 자바스크립트의 초기 목적: 자바스크립트는 초기에는 웹 페이지의 동적인 요소를 다루기 위한 간단한 스크립트 언어로 시작되었습니다. 이 때문에 단일 스레드로 충분하다고 판단되었고, 이후 웹 애플리케이션의 규모와 복잡성이 증가합에 따라 비동기 처리 모델이 강조된 것입니다.

### 🍔 자바스크립트를 싱글 스레드로 만들어지며 가진 이점들

자바스크립트를 싱글 스레드로 만든 이점 중 간결성, 단순성 그리고 웹 브라우저 환경에서의 안전성이 주요 이유이지만 몇 가지 다른 이점들이 존재합니다.

- 자바스크립트 비동기 처리 모델은 이벤트 루프를 기반으로 하며, 이를 통해 비동기 작업을 간단하게 처리할 수 있습니다. 이 모델은 **싱글 스레드에서도 효과적으로 동작하며, 복잡한 동시성 문제를 간소화할 수 있습니다.**

- 싱글 스레드로 동작하는 자바스크립트는 쉬운 학습 곡선을 가지고 있습니다. 멀티 스레드 환경에서는 동시성과 동기화에 대한 개념을 이해해야 하므로 더 어려울 수 있습니다.

- 싱글 스레드로 동작하는 자바스크립트는 호환성이 뛰어나며, 어떤 환경에서도 실행될 수 있습니다. 이로 인해 코드가 예측 가능하고 안정적으로 동작할 가능성이 높아집니다.

- 멀티 스레드 환경에서는 메모리 관리와 동기화 등이 복잡해지는데, 싱글 스레드로 동작하는 자바스크립트는 이러한 부분을 단순화할 수 있습니다.

### 🍔 자바스크립트를 싱글 스레드로 만들어지며 가진 이점들

싱글 스레드로 동작하는 자바스크립트의 주요 단점 중 하나는 '블로킹'입니다. 블로킹이란 하나의 작업이 완료될 때까지 다음 작업이 실행되지 않는 현상을 말합니다. 이로 인해 CPU 사용률이 낮아질 수 있고, 사용자 경험에 영향을 미칠 수 있습니다.

- 만약 어떤 코드가 오래 걸리는 작업을 수행한다면, 그 코드 부분에서는 다음 작업이 실행되지 않습니다. 이는 특히 네트워크 요청이나 데이터베이스 쿼리와 같은 I/O 작업에서 발생할 수 있어 치명적입니다.

- 멀티 코어 CPU가 일반적으로 사용되는 현대 시스템에서 싱글 스레드로 동작하는 자바스크립트는 병렬성을 제대로 활용하지 못할 수 있습니다. 이로인해 CPU 리소스의 효율성이 떨어질 수 있습니다.

이러한 단점들을 보완하기 위해 다양한 기술과 전략을 사용합니다.

- **비동기 프로그래밍**
- **Web Workers**
  - 웹 워커는 백그라운드에서 별도의 스레드에서 코드를 실행할 수 있도록 해줍니다. 이를 통해 CPU 진행을 방해하지 않고 병렬성을 활용할 수 있습니다.
- **Promise 및 Async/Await**
  - 비동기 코드를 더 쉽게 작성하고 관리할 수 있도록 하는 기능들이 도입되었습니다. 이를 통해 코드의 가독성과 유지보수성이 향상되었습니다.
- **콜백 함수**
  - 비동기 작업의 결과를 처리하기 위해 콜백 함수를 사용할 수 있습니다.

이러한 기술과 패턴은 싱글 스레드로 동작하는 자바스크립트에서도 성능을 최적화하고 효과적으로 다양한 작업을 수행할 수 있도록 도와줍니다.

---

## 자바스크립트와 이벤트 루프 그리고 비동기 처리

자바스크립트의 특징은 싱글 스레드라는 점입니다. 스레드가 하나라는 말은 동시에 하나의 작업만을 처리할 수 있다는 것을 의미합니다. 하지만 우리는 웹 브라우저에서 애니메이션 효과를 보여주면서도 마우스 입력을 받아 처리하고 웹 서버에서는 클라이언트의 http 요청을 처리하는 것을 볼 수 있습니다. 하나의 스레드인데 동시성을 지원하는 것입니다.

이 때 등장하는 개념이 이벤트 루프입니다. 자바스크립트는 이벤트 루프를 사용해 비동기 방식으로 동시성을 지원합니다.

### ECMAScript(자바스크립트 표준을 정의한 문서 및 규격)는 이벤트 루프가 없다.

실제 JS엔진은 단일 호출 스택을 이용해 요청이 들어올 때마다 해당 요청을 **순차적**으로 호출 스택에 답아 처리할 뿐입니다.

비동기 요청 그리고 동시성에 대한 처리는 JS 엔진을 구동하는 환경인 Node.js(V8 자바스크립트 엔진으로 빌드된 자바스크립트 런타임 환경)가 담당합니다.

비동기 호출을 위해 사용하는 setTimeout, XMLHttpRequest와 같은 함수들은 JS 엔진이 아닌 브라우저의 Web API 영역에 따로 정의되어 있습니다.

즉, JS 엔진은 비동기 작업을 위해 Node.js의 API를 호출하며, 이 때 넘겨진 콜백은 libuv의 이벤트 루프를 통해 스케쥴되고 실행됩니다.

⭐️ libuv는 Node.js의 핵심 컴포넌트 중 하나로, 크로스 플랫폼 비동기 I/O(입출력)를 지원하는 라이브러리입니다.

### 단일 호출 스택과 Run-to-Completion

**자바스크립트의 함수가 실행되는 방식**을 보통 Run-to-Completion이라고 말합니다.

**이는 하나의 함수가 실행되면 이 함수의 실행이 끝날 때까지 다른 어떤 작업도 중간에 끼어들 수 없다는 의미입니다.**

JS 엔진은 하나의 호출 스택을 사용하며, 현재 스택에 쌓여있는 모든 함수들이 실행을 마치고 스택에서 제거되기 전까지 다른 어떠한 함수도 실행되지 않습니다.

#### 비동기 동작을 보여주는 예시 코드입니다.

```jsx
function delay() {
  for (var i = 0; i < 100000; i++);
}

function foo() {
  delay();
  bar();
  console.log('foo!'); //(2)
}

function bar() {
  delay();
  console.log('bar!'); //(1)
}

function baz() {
  console.log('baz!'); //(3)
}

setTimeout(baz, 10);
foo();
```

결과: bar! -> foo! -> 10밀리초 쉬고 -> baz!

### 태스크 큐와 이벤트 루프

- 코드가 처음 실행되면 이 코드는 현재 실행중인 태스크가 됩니다.

- 코드를 실행하는 도중 10ms가 지나면 브라우저의 타이머가 baz를 바로 실행하지 않고 태스트 큐에 추가합니다.

- 이벤트 루프는 현재 실행중인 태스크가 종료되자마자 태스크 큐에 대기중인 첫 번째 태스크를 실행합니다.

- foo 함수 실행을 마치고 호출 스택이 비워지면 현재 실행중인 태스크는 종료되고 이 때, 이벤트 루프가 태스크 큐에 대기중인 첫 번째 태스크인 baz를 실행해서 호출 스택에 추가합니다.

(이벤트 루프는 현재 실행중인 태스크가 없는지와 태스트 큐에 다음 실행할 태스크가 있는지를 반복적으로 확인하는 것입니다.)

- 모든 비동기 API들은 작업이 완료되면 콜백 함수를 태스크 큐에 추가

- 이벤트 루프는 현재 실행중인 태스크가 없을 때 태스크 큐의 첫 번째 태스크를 꺼내와 실행합니다.

### 비동기 API

setTimeout 뿐만 아니라 브라우저의 다른 비동기 함수들 그리고 node.js 모든 비동기 방식의 api들은 이벤트 루프를 통해 콜백 함수를 실행합니다.

### 비동기 방식

비동기는 메인 스레드가 작업을 다른 곳에 인가하여 처리되게 하고 그 작업이 완료되면 콜백 함수를 받아 실행하는 방식으로, 쉽게 말해 작업을 백그라운드에 요청하여 처리되게 해 작업을 동시에 처리하는 것으로 보면 됩니다.

웹 애플리케이션에서 데이터베이스 쿼리를 수행하는 작업이 있다고 가정했을 때, 동기적으로 수행하게 되면 응답이 올 때까지 기다려야 하고 그러면 이 애플리케이션은 다른 요청을 처리할 수 없어 대규모 트래픽이 발생할 경우 웹 애플리케이션의 성능이 저하될 수 있습니다.

하지만 비동기 방식으로 동일한 일을 수행하면, 데이터베이스에서 응답이 올 때까지 기다리는 동안 다른 요청을 처리할 수 있기 때문에 자원을 효율적으로 사용할 수 있는 것입니다. 이렇게 비동기 방식을 사용하면 대규모 트래픽에서도 안정적으로 동작할 수 있는 웹 애플리케이션을 만들 수 있습니다.

---

## V8 (자바스크립트 엔진)

### wikipedia

V8은 웹 브라우저를 만드는 데 기반을 제공하는 **오픈 소스 자바스크립트 엔진**입니다. V8 엔진은 구글 크롬 브라우저와 안드로이드 브라우저에 탑재되어 있습니다.
ECMAScript 3rd Edition 규격의 C++로 작성되었으며, 독립적으로 실행이 가능합니다.

V8은 자바스크립트를 바이트코드로 컴파일하고 실행하는 방식을 사용합니다.
😟 (JIT 컴파일) 기계어로 정적 컴파일하여 실행한다는 루머가 있지만 사실이 아니라고 합니다.

추가적인 **속도 향상**을 위한 ‘인라인 캐싱’ 과 같은 최적화 기법을 적용하였습니다.

✨ 인라인 캐싱: 객체의 프로퍼티를 어디서 찾아야 하는지에 대한 정보를 캐싱함으로써 자바스크립트의 성능을 최적화하는 주된 요소

---

V8 엔진은 Google이 개발한 오픈소스로 가장 대중적인 자바스크립트 엔진입니다.
C++로 개발되었고 Node.js 런타임 및 Chrome 브라우저에서 사용되고 있습니다.

컴퓨터는 0과 1밖에 이해하지 못합니다. 하지만 고수준 언어인 자바스크립트 파일을 이해하고 명령을 수행할 수 있는데, 이는 자바스크립트 엔진이 컴퓨터가 읽을 수 있는 최적화된 코드로 변환되어 전달하면서 컴퓨터가 자바스크립트 파일을 이해하고 수행할 수 있는 것입니다.

즉, 자바스크립트 엔진은 자바스크립트 코드를 마이크로프로세서가 이해할 수 있게 기계어로 변환해서 실행하는 프로그램 또는 인터프리터를 말합니다.

✨ 인터프리터: 자바스크립트 파일을 입력받으면 **코드를 한 줄 한 줄 해석**하면서 기계어로 번역하는 방식입니다. 코드를 실행하기 전 컴파일 단계가 없기 대문에 **실행 속도가 빠르다**는 장점이 있습니다.

✨ 컴파일러: 자바스크립트 파일을 입력받으면 파일 전체를 읽은 뒤, 이를 컴파일하여 기계어로 변환합니다. 그리고 이 기계어는 CPU로 입력되어 코드가 실행됩니다.

- 컴파일러는 작업을 단순화 시키는 장점이 있습니다. 특정 함수를 10억번 반복해야 하는 경우, 컴파일 과정에서 함수를 반복하는 것이 아닌 함수의 결과물을 반복하도록 컴파일하며 불필요한 동작을 제거하는 방식인 최적화를 수행합니다.

### V8 엔진이 만들어진 이유

V8은 웹 브라우저 내부에서 자바스크립트 수행 속도의 개선을 목표로 처음 고안되었습니다.

여러 자바스크립트 엔진이 사용 되어 왔지만 웹 특성상 유저와 상호작용을 위해 즉시성이 있는 **인터프리터** 방식을 사용하는데, 코드가 많아질수록 속도가 느려진다는 단점이 있었습니다. 이 점을 보완해서 속도 향상을 위해 V8 엔진은 인터프리터를 사용하는 대신 **JIT(Just In Time) 컴파일러를 구현**함으로써 코드 실행 시에 자바스크립트 코드를 **머신 코드로 컴파일** 합니다.

우리 컴퓨터 안에는 마이크로프로세서라는 작은 기계가 있습니다. 프로그래머가 어떤 코드를 작성하고 컴퓨터에게 일을 시키려면 결국 이 마이크로프로세서가 해석할 수 있는 언어로 전달해야 합니다. 결국, 프로그래머들은 프로그래밍 효율을 위해 추상화 수준이 높은 고수준의 언어를 사용해서 코딩을 하지만 머신 코드로 컴파일 되어야만 CPU가 이해하고 처리할 수 있기 때문에 머신 코드로 컴파일 합니다.

### JITC (Just In Time Compiler)

JIT 컴파일, 동적 번역은 프로그램을 실제 실행하는 시점에 기계어로 번역하는 컴파일 기법입니다.
JITC로 프로파일링을 통해 최적화할 코드를 선별한 후 해당 코드들만 컴파일합니다. 이 기법은 프로그램의 실행 속도를 빠르게 하기 위해 사용됩니다.

### V8 작동 원리

1. V8 엔진은 자바스크립트 소스코드를 가져와서 Parser에게 보냅니다.
   - Parser는 낱말 분석(Lexical Analysis)이라는 과정을 통해 코드를 토큰으로 분해합니다.

```jsx
let a = 5 -> ['let', 'a', '=', '5'];

```

1. Parser에서 분리된 토큰을 바탕으로 AST(Abstract Syntax Tree)를 생성합니다.
   - https://yceffort.kr/2021/05/ast-for-javascript
2. AST에서 나온 코드가 인터프리터인 Ignition에게 전달됩니다.
   - 인터프리터인 Ignition에서는 코드를 빠르게 AST를 바이트 코드로 중간 번역하고 실행시킵니다.
3. 코드를 점화하여 바이트 코드를 생성 및 실행합니다. V8 엔진은 런타임 과정 중 Profiler에게 지속적인 프로파일링(함수난 변수들의 호출 빈도와 같은 데이터를 모으라고 시킴)을 통해 Host spot(반복되어 사용하는 코드 등 과열 지점)을 찾습니다. 바이트 코드가 실행될 때 Profiler는 프로파일링 데이터를 수집하여 최적화할 수 있는 부분을 기록합니다.
4. 컴파일러는 프로파일러에게 전달받은 내용을 토대로 기계어로 변환하여 최적화를 진행합니다.
   - 최적화 가능한 부분을 찾으면 이를 컴파일러에게 전달하고, 컴파일러는 인터프리터에 의해 실시간으로 웹 사이트가 구동되는 동안 필요한 부분을 기계어로 변환하여 최적화를 진행합니다.
   - 과열 코드는 TurboFan(최적화 컴파일러)으로 보내 최적화 컴파일을 진행합니다.
   - 만약 최적화 컴파일을 진행했더라도 변수의 타입이 바뀐다거나 하는 동적 환경의 변수에 따라 네이티브 코드를 다시 바이트 코드로 Deoptimizing 하기도 합니다. Deoptimizing된 코드도 상황에 따라서 얼마든지 다시 최적화 컴파일링되기도 합니다.
5. 최적화 코드르 수행할 차례가 다가오면 바이트코드 대신 컴파일러가 변환한 최적화된 코드가 그 자리를 대체하여 실행됩니다.
   - 최적화 기법으로는 히든 클래스(Hidden Class)나 인라인 캐싱(Inline Caching) 등 여러가지 기법을 사용합니다.

### 정리

- V8 엔진의 작동 원리
  - 파서에게 코드를 전달하여 AST를 생성하고, 이를 인터프리터 Ignition에서 빠르게 바이트 코드로 변환 및 실행합니다.
  - 프로파일러를 통해 Profiling을 수행하고, Profiler로부터 얻은 정보를 TurboFan 컴파일러에 전달하여 최적화를 진행합니다.
  - 최적화된 코드가 필요한 부분은 최적화된 코드로 교체되어 실행됩니다.
- 인라인 캐싱과 최적화
  - 인라인 캐싱과 같은 최적화 기법을 통해 성능을 향상시킵니다.
  - Profiler는 코드를 프로파일링하고 TurboFan 컴파일러가 최적화를 수행하여 성능을 극대화합니다.
- 자바스크립트 엔진과 메모리 관리
  - V8은 힙과 스택을 효율적으로 관리하며, 가비지 컬렉션을 통해 더 이상 필요하지 않은 객체를 정리합니다.

⭐️ Ignition은 엔진에 시동걸 때 사용하는 점화기이고 너무 많이 호출돼서 과열되면 TurboFan으로 최적화해서 너무 과열되지 않게 식혀주는 느낌으로 생각하시면 됩니다. 여. 러. 분 🐣

⭐️ V8의 컴파일 파이프라인을 설명할 때 빠지지 않았던 Full-codegen과 Crankshaft라는 개념이 있었다고 합니다. v5.9부터 자바스크립트의 새로운 기능과 이러한 기능들이 요구하는 최적화 기능을 더 이상 따라갈 수 없기 때문에 V8에서 더이상 사용되지 않는다고 합니다. V8 팀은 이것들을 완전히 제거할 것이고 V8은 앞으로 훨씬 더 단순하고 유지 보수 가능한 아키텍처를 갖게 될 것이라고 합니다.

⭐️ V8 엔진은 WebAssembly를 처리하여 실행합니다.
웹어셈블리는 C, C++, Rust 등의 언어로 작성된 코드를 웹 애플리케이션에서 실행하기 위한 목적으로 작성되었습니다. 웹 어셈블리는 기계어 수준의 이진 형식으로, 브라우저에서 직접 실행됩니다. 브라우저의 자바스크립트 엔진보다 더 빠른 실행 속도를 제공하며, 높은 성능을 가능하게 합니다. 웹 플랫폼과의 통합이 자유롭고 모듈화된 형태로 제작되어 다양한 웹 애플리케이션에서 재사용이 가능합니다. 그리고 웹 어셈블리는 격리된 환경에서 실행되며, 브라우저와 안전한 방식으로 상호작용을 하기 때문에 보다 안전한 웹 애플리케이션을 가능케 합니다.
주로 웹에서 높은 성능이 필요한 작업을 수행하는 데 사용되며, 병렬 처리, 게임 개발, 미디어 처리 등의 작업에 활용됩니다.

(멘토님이 공부하시는 Rust, 2023 프로그래머스 개발자 설문조사에서 프론트엔드 개발자가 배우고 싶은 언어 1위를 TypeScript, 2위를 Rust를 꼽았습니다. 다들 한 번씩 해보시는 것도... 조타!)

---

## 오늘의 퀴즈

🫨 다음 중 브라우저의 비동기 API인 것을 모두 고르세요.

1️⃣ setTimeout

2️⃣ addEventListener

3️⃣ XMLHttpRequest

---

🫨 자바스크립트 언어 자체에서 제공하는 비동기 처리 매커니즘인 것을 모두 고르세요.

1️⃣ Promise

2️⃣ Async/Await

3️⃣ fetch
